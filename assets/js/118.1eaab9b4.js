(window.webpackJsonp=window.webpackJsonp||[]).push([[118],{544:function(s,e,n){"use strict";n.r(e);var a=n(15),t=Object(a.a)({},(function(){var s=this,e=s.$createElement,n=s._self._c||e;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h2",{attrs:{id:"前言"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#前言"}},[s._v("#")]),s._v(" "),n("strong",[s._v("前言")])]),s._v(" "),n("p",[s._v("Nginx+Tomcat对Session的管理一直有了解，但是一直没有实际操作一遍，本文从最简单的安装启动开始，通过实例的方式循序渐进的介绍了几种管理session的方式。")]),s._v(" "),n("h2",{attrs:{id:"nginx安装配置"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#nginx安装配置"}},[s._v("#")]),s._v(" "),n("strong",[s._v("nginx安装配置")])]),s._v(" "),n("h3",{attrs:{id:"_1-安装nginx"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-安装nginx"}},[s._v("#")]),s._v(" 1.安装nginx")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("[root@localhost ~]# yum install nginx\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("提示报如下错误：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("No package nginx available.\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("解决办法安装epel：EPEL是企业版 Linux 附加软件包的简称，EPEL是一个由Fedora特别兴趣小组创建、维护并管理的，针对 红帽企业版 Linux(RHEL)及其衍生发行版(比如 CentOS、Scientific Linux、Oracle Enterprise Linux)的一个高质量附加软件包项目；")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("[root@localhost ~]# yum install epel-release\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("安装完之后，即可成功安装nginx；")]),s._v(" "),n("h3",{attrs:{id:"_2-启动、停止nginx"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-启动、停止nginx"}},[s._v("#")]),s._v(" 2.启动、停止nginx")]),s._v(" "),n("p",[s._v("先进入nginx的目录")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("[root@localhost nginx]# cd /usr/sbin/\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("执行命令")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("./nginx 开启\n./nginx -s stop  使用kill命令强制杀掉进程\n./nginx -s quit  待nginx进程处理任务完毕进行停止\n./nginx -s reload\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("h2",{attrs:{id:"nginx-tomcat负载均衡"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#nginx-tomcat负载均衡"}},[s._v("#")]),s._v(" "),n("strong",[s._v("nginx+tomcat负载均衡")])]),s._v(" "),n("h3",{attrs:{id:"_1-准备2个tomcat-分别指定端口为8081-8082"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-准备2个tomcat-分别指定端口为8081-8082"}},[s._v("#")]),s._v(" 1.准备2个tomcat，分别指定端口为8081，8082")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("drwxr-xr-x. 9 root root      4096 May  7 14:16 apache-tomcat-7.0.88_8081\ndrwxr-xr-x. 9 root root      4096 May  7 14:16 apache-tomcat-7.0.88_8082\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("p",[s._v("修改webapps/ROOT的index.jsp，方便测试")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('<%\nif(request.getSession().getAttribute("key")==null){\n   out.println("key is null,ready init.....");   \n   request.getSession().setAttribute("key","value");\n}else{\n   out.println("key is not null,key="+request.getSession().getAttribute("key"));  \n}\n%>\n<br> \nsessionID:<%=session.getId()%>   \n<br>   \nsessionCreateTime:<%= session.getCreationTime() %>\n<br>\n<% \nout.println("tomcat port 8081");   \n%> \n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br")])]),n("p",[s._v("最后的输出在两个tomcat下面指定各自的端口号8081和8082")]),s._v(" "),n("h3",{attrs:{id:"_2-nginx配置负载均衡-默认策略"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-nginx配置负载均衡-默认策略"}},[s._v("#")]),s._v(" 2.nginx配置负载均衡(默认策略)")]),s._v(" "),n("p",[s._v("修改/etc/nginx/下面的nginx.conf")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("upstream tomcatTest {\n     server 127.0.0.1:8081;   #tomcat-8081\n     server 127.0.0.1:8082;   #tomcat-8082\n}\n \nserver {\n    listen       80 default_server;\n    listen       [::]:80 default_server;\n    server_name  _;\n    root         /usr/share/nginx/html;\n \n    # Load configuration files for the default server block.\n    include /etc/nginx/default.d/*.conf;\n \n    location / {\n        proxy_pass http://tomcatTest;\n    }\n \n    error_page 404 /404.html;\n        location = /40x.html {\n    }\n \n    error_page 500 502 503 504 /50x.html;\n        location = /50x.html {\n    }\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br")])]),n("p",[s._v("此处配置的负载均衡策略是默认的轮询策略，nginx还支持其他策略包括：ip_hash、weight、fair(第三方)、url_hash(第三方)；"),n("br"),s._v("\n默认策略每个web请求按时间顺序逐一分配到不同的后端服务器，这种情况下每次请求都会创建一个新的session，下面做简单测试:"),n("br"),s._v("\n第一次请求"),n("a",{attrs:{href:"http://ip/",target:"_blank",rel:"noopener noreferrer"}},[s._v("http://ip/"),n("OutboundLink")],1)]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("key is null,ready init..... \nsessionID:E7A9782DED29FF04E21DF94078CB4F62 \nsessionCreateTime:1527732911441\ntomcat port 8082\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("p",[s._v("第二次刷新"),n("a",{attrs:{href:"http://ip/",target:"_blank",rel:"noopener noreferrer"}},[s._v("http://ip/"),n("OutboundLink")],1)]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("key is null,ready init..... \nsessionID:7812E8E21DBB74CC7FBB75A0DFF2E9CB \nsessionCreateTime:1527732979810\ntomcat port 8081\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("p",[s._v("第三次刷新"),n("a",{attrs:{href:"http://ip/",target:"_blank",rel:"noopener noreferrer"}},[s._v("http://ip/"),n("OutboundLink")],1)]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("key is null,ready init..... \nsessionID:8895F41E299785A21995D5F8BB734B86 \nsessionCreateTime:1527733011878\ntomcat port 8082\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("p",[s._v("可以发现每次都产生一个新的session，而且消息按时间顺序逐一分配到不同的后端服务器，一般需要保持session会话的网站都不允许出现每次请求都产生一个session；")]),s._v(" "),n("h3",{attrs:{id:"_3-nginx配置负载均衡-黏性session"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-nginx配置负载均衡-黏性session"}},[s._v("#")]),s._v(" 3.nginx配置负载均衡(黏性Session)")]),s._v(" "),n("p",[s._v("每个请求按访问ip的hash结果分配，这样每个访客固定访问一个后端服务器，可以解决session的问题；nginx可以通过在upstream模块配置ip_hash来实现黏性Session；")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("upstream tomcatTest {\n     ip_hash;\n     server 127.0.0.1:8081;   #tomcat-8081\n     server 127.0.0.1:8082;   #tomcat-8082\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("p",[s._v("下面做简单测试:"),n("br"),s._v("\n第一次请求"),n("a",{attrs:{href:"http://ip/",target:"_blank",rel:"noopener noreferrer"}},[s._v("http://ip/"),n("OutboundLink")],1)]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("key is null,ready init..... \nsessionID:859BADFB09A4ECEAEC5257F518C228A0 \nsessionCreateTime:1527734181450\ntomcat port 8081\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("p",[s._v("第二次刷新"),n("a",{attrs:{href:"http://ip/",target:"_blank",rel:"noopener noreferrer"}},[s._v("http://ip/"),n("OutboundLink")],1)]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("key is not null,key=value \nsessionID:859BADFB09A4ECEAEC5257F518C228A0 \nsessionCreateTime:1527734181450\ntomcat port 8081\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("p",[s._v("第三次刷新"),n("a",{attrs:{href:"http://ip/",target:"_blank",rel:"noopener noreferrer"}},[s._v("http://ip/"),n("OutboundLink")],1)]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("key is not null,key=value \nsessionID:859BADFB09A4ECEAEC5257F518C228A0 \nsessionCreateTime:1527734181450\ntomcat port 8081\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("p",[s._v("可以发现第一次请求设置了key=value,后面每次都能获取到key值，sessionId没有改变，tomcat也没有改变，实现了黏性Session；"),n("br"),s._v("\n此时可以把port=8081的tomcat停掉，然后再观察"),n("br"),s._v("\n第四次刷新"),n("a",{attrs:{href:"http://ip/",target:"_blank",rel:"noopener noreferrer"}},[s._v("http://ip/"),n("OutboundLink")],1)]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("key is null,ready init..... \nsessionID:3C15FE2C8E8A9DCDC6EAD48180B78B80 \nsessionCreateTime:1527735994476\ntomcat port 8082\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("p",[s._v("第五次刷新"),n("a",{attrs:{href:"http://ip/",target:"_blank",rel:"noopener noreferrer"}},[s._v("http://ip/"),n("OutboundLink")],1)]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("key is not null,key=value \nsessionID:3C15FE2C8E8A9DCDC6EAD48180B78B80 \nsessionCreateTime:1527735994476\ntomcat port 8082\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("p",[s._v("可以发现消息转发到了tomcat-8082，并且session丢失，重新创建了新的session；"),n("br"),s._v("\n如何让这种情况session不丢失，也有两种方案：Session复制和Session共享；Session共享从扩展性，性能方面都更加好，下面重点介绍一下Session共享如何实现；")]),s._v(" "),n("h2",{attrs:{id:"nginx-tomcat实现session共享"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#nginx-tomcat实现session共享"}},[s._v("#")]),s._v(" "),n("strong",[s._v("nginx+tomcat实现Session共享")])]),s._v(" "),n("p",[s._v("Session共享思想就是把session保存到一个公共的地方，用的时候再从里面取出来，具体这个公共的地方可以是：redis，db，memcached等，下面已redis为实例")]),s._v(" "),n("h3",{attrs:{id:"_1-redis安装配置"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-redis安装配置"}},[s._v("#")]),s._v(" 1.redis安装配置")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("yum install redis\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("安装完成以后配置文件/etc/redis.conf"),n("br"),s._v("\n启动redis服务端")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("redis-server /etc/redis.conf\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("启动客户端")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("redis-cli\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("h3",{attrs:{id:"_2-tomcat引入依赖的jar"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-tomcat引入依赖的jar"}},[s._v("#")]),s._v(" 2.Tomcat引入依赖的jar")]),s._v(" "),n("p",[s._v("$TOMCAT_HOME/lib添加如下jar包")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("<dependency>\n    <groupId>com.bluejeans</groupId>\n    <artifactId>tomcat-redis-session-manager</artifactId>\n    <version>2.0.0</version>\n</dependency>\n<dependency>\n    <groupId>redis.clients</groupId>\n    <artifactId>jedis</artifactId>\n    <version>2.5.2</version>\n</dependency>\n<dependency>\n    <groupId>org.apache.commons</groupId>\n    <artifactId>commons-pool2</artifactId>\n    <version>2.2</version>\n</dependency>\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br")])]),n("h3",{attrs:{id:"_3-tomcat修改配置"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-tomcat修改配置"}},[s._v("#")]),s._v(" 3.Tomcat修改配置")]),s._v(" "),n("p",[s._v("修改$TOMCAT_HOME/conf目录下的context.xml文件")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('<Valve className="com.orangefunction.tomcat.redissessions.RedisSessionHandlerValve" />\n<Manager className="com.orangefunction.tomcat.redissessions.RedisSessionManager"\n         host="localhost"\n         port="6379"\n         database="0"\n         maxInactiveInterval="60"/>\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br")])]),n("p",[s._v("Tomcat提供了一个开放的session管理和持久化的org.apache.catalina.session.ManagerBase，继承这个抽象类并做一些简单的配置，即可让你的session管理类接管Tomcat的session读取和持久化，这里使用的是"),n("a",{attrs:{href:"https://github.com/jcoleman/tomcat-redis-session-manager",target:"_blank",rel:"noopener noreferrer"}},[s._v("tomcat-redis-session-manager"),n("OutboundLink")],1),s._v("来管理session；"),n("br"),s._v("\nRedisSessionManager继承于org.apache.catalina.session.ManagerBase类，对session的相关操作都在此类中；")]),s._v(" "),n("h3",{attrs:{id:"_4-测试"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-测试"}},[s._v("#")]),s._v(" 4.测试")]),s._v(" "),n("p",[s._v("第一次请求"),n("a",{attrs:{href:"http://ip/",target:"_blank",rel:"noopener noreferrer"}},[s._v("http://ip/"),n("OutboundLink")],1)]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("key is null,ready init..... \nsessionID:1131499E5A65DE1591152465E7B24B1F \nsessionCreateTime:1527740273682\ntomcat port 8081\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("p",[s._v("第二次刷新"),n("a",{attrs:{href:"http://ip/",target:"_blank",rel:"noopener noreferrer"}},[s._v("http://ip/"),n("OutboundLink")],1)]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("key is not null,key=value \nsessionID:1131499E5A65DE1591152465E7B24B1F \nsessionCreateTime:1527740273682\ntomcat port 8081\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("p",[s._v("将tomcat-8081停掉， 第三次刷新"),n("a",{attrs:{href:"http://ip/",target:"_blank",rel:"noopener noreferrer"}},[s._v("http://ip/"),n("OutboundLink")],1)]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("key is not null,key=value \nsessionID:1131499E5A65DE1591152465E7B24B1F \nsessionCreateTime:1527740273682\ntomcat port 8082\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("p",[s._v("可以发现此时消息已经转发到tomcat-8082节点了，但是session没有改变，同时key也可以获取到值；")]),s._v(" "),n("p",[s._v("5.查看redis")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('[root@localhost ~]# redis-cli\n127.0.0.1:6379> keys *\n1) "1131499E5A65DE1591152465E7B24B1F"\n127.0.0.1:6379> get 1131499E5A65DE1591152465E7B24B1F\n"\\xac\\xed\\x00\\x05sr\\x00Dcom.orangefunction.tomcat.redissessions.SessionSerializationMetadataB\\xd9\\xd9\\xf7v\\xa2\\xdbL\\x03\\x00\\x01[\\x00\\x15sessionAttributesHasht\\x00\\x02[Bxpw\\x14\\x00\\x00\\x00\\x10}\\xc8\\xc9\\xcf\\xf6\\xc3\\xb5Y\\xc7\\x0c\\x8eF\\xa5\\xfaQ\\xe8xsr\\x00\\x0ejava.lang.Long;\\x8b\\xe4\\x90\\xcc\\x8f#\\xdf\\x02\\x00\\x01J\\x00\\x05valuexr\\x00\\x10java.lang.Number\\x86\\xac\\x95\\x1d\\x0b\\x94\\xe0\\x8b\\x02\\x00\\x00xp\\x00\\x00\\x01c\\xb4j\\x94\\x12sq\\x00~\\x00\\x03\\x00\\x00\\x01c\\xb4j\\x94\\x12sr\\x00\\x11java.lang.Integer\\x12\\xe2\\xa0\\xa4\\xf7\\x81\\x878\\x02\\x00\\x01I\\x00\\x05valuexq\\x00~\\x00\\x04\\x00\\x00\\a\\bsr\\x00\\x11java.lang.Boolean\\xcd r\\x80\\xd5\\x9c\\xfa\\xee\\x02\\x00\\x01Z\\x00\\x05valuexp\\x01q\\x00~\\x00\\nsq\\x00~\\x00\\x03\\x00\\x00\\x01c\\xb4j\\x94*t\\x00 1131499E5A65DE1591152465E7B24B1Fsq\\x00~\\x00\\a\\x00\\x00\\x00\\x01t\\x00\\x03keyt\\x00\\x05valuew\\b\\x00\\x00\\x01c\\xb4j\\x94\\x12"\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("p",[s._v("可以发现redis里面已经存放了session对象，并且使用sessionId作为key值，存放了session的二进制数据；")]),s._v(" "),n("h2",{attrs:{id:"总结"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[s._v("#")]),s._v(" "),n("strong",[s._v("总结")])]),s._v(" "),n("p",[s._v("本文简单介绍了Nginx整合Tomcat，以及Nginx的负载均衡策略，用实例的方式展示了默认策略和ip_hash策略对session的管理；最后介绍了使用session共享的方式来解决前两种方式对session管理的弊端；后续继续了解Tomcat是如何将session读取和持久化交给其他系统管理的，session更新是否实时，序列化方案，有效期等问题。")])])}),[],!1,null,null,null);e.default=t.exports}}]);