(window.webpackJsonp=window.webpackJsonp||[]).push([[110],{536:function(s,t,a){"use strict";a.r(t);var n=a(15),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h3",{attrs:{id:"架构描述"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#架构描述"}},[s._v("#")]),s._v(" 架构描述")]),s._v(" "),a("p",[s._v("前端一台nginx服务器做负载均衡器，后端放N台tomcat组成集群处理服务，通过nginx转发到后面（注：没做动静分离，静态动态全部都转给tomcat）")]),s._v(" "),a("p",[s._v("优点：")]),s._v(" "),a("p",[s._v("实现了可弹性化的架构，在压力增大的时候可以临时添加tomcat服务器添加到这个架构里面去。")]),s._v(" "),a("h3",{attrs:{id:"一配置nginx"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#一配置nginx"}},[s._v("#")]),s._v(" 一配置nginx")]),s._v(" "),a("h4",{attrs:{id:"_1-下载包"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-下载包"}},[s._v("#")]),s._v(" 1.下载包")]),s._v(" "),a("p",[s._v("Wget http://sysoev.ru/nginx/nginx-0.6.32.tar.gz")]),s._v(" "),a("p",[s._v("ftp://ftp.csx.cam.ac.uk/pub/software/programming/pcre/")]),s._v(" "),a("h4",{attrs:{id:"_2-安装nginx包"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-安装nginx包"}},[s._v("#")]),s._v(" 2.安装nginx包")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("##安装pcre\ntar zxvf pcre-7.2.tar.gz\ncd pcre\n ./configure  --prefix = /pcre\nMake;\nmake install\n\n## 安装nginx\ntar zxvf nginx-0.6.32.tar.gz\ncd nginx-0.6.32\n./configure  --prefix=/nginx –with-pcre=/pcre  --with-http_rewrite_module\nMake;make install\n")])])]),a("h4",{attrs:{id:"_3-修改配置文件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-修改配置文件"}},[s._v("#")]),s._v(" 3.修改配置文件")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("Vi /nginx/conf/nginx.conf\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("div",{staticClass:"language-nginx line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-nginx"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#用户组")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("user")]),s._v(" nobody nobody")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("                 \n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#cpu个数，可以按照实际服务器来计算")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("worker_processes")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("                \n"),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("worker_rlimit_nofile")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("51200")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("         \n"),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("events")])]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("use")]),s._v(" epoll")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#连接数")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("worker_connections")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8192")])]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("      \n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("http")])]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("include")]),s._v("       mime.types")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("default_type")]),s._v("  application/octet-stream")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("server_names_hash_bucket_size")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("128")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#    access_log  off;")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#    access_log  logs/access.log;")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#缓存的时间，（可以根据不同文件设置不同时间）")]),s._v("\n "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#   expires           2h;      ")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("tcp_nodelay")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("on")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("keepalive_timeout")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("30")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("      \n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("gzip")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("on")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("gzip_min_length")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("gzip_buffers")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8k")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("gzip_http_version")]),s._v(" 1.1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("gzip_types")]),s._v("       text/plain application/x-javascript text/css text/html application/xml")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("sendfile")]),s._v("         "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("on")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("tcp_nopush")]),s._v("       "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("on")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("reset_timedout_connection")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("on")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n     "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("client_max_body_size")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("30m")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" \n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#设定负载均衡列表       ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("upstream")]),s._v("  backend")]),s._v("           \n "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("                      \n"),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("server")]),s._v("   172.23.254.2:8080")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("   \n"),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("server")]),s._v("   172.23.254.3:8080")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#设定虚拟主机")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("server")])]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("listen")]),s._v("       "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("server_name")]),s._v("  www.abc.com")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#对 / 所有做负载均衡 （本机nginx采用完全转发，所有请求都转发到后端的tomcat集群）")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("location")]),s._v(" /")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("       \n        "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("root")]),s._v(" /web/www")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n       "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("index")]),s._v(" index.jsp index.htm index.html")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("proxy_redirect")]),s._v("         "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("off")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#保留用户真实信息")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("proxy_set_header")]),s._v("       Host "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$host")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n              "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("proxy_set_header")]),s._v("  X-Real-IP  "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$remote_addr")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("proxy_set_header")]),s._v("  X-Forwarded-For "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$proxy_add_x_forwarded_for")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n       "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("proxy_pass")]),s._v("  http://backend")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("   \n       "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br")])]),a("p",[s._v("主要在配置proxy与upstream")]),s._v(" "),a("p",[s._v("Upstream具有负载均衡能力，可以自动判断下面的机器，并且自动踢出不能正常提供服务的机器。")]),s._v(" "),a("h4",{attrs:{id:"_4-启动程序"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-启动程序"}},[s._v("#")]),s._v(" 4.启动程序")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("/nginx/sbin/nginx\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h4",{attrs:{id:"_5-编写启动脚本"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-编写启动脚本"}},[s._v("#")]),s._v(" 5.编写启动脚本")]),s._v(" "),a("div",{staticClass:"language-nginx line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-nginx"}},[a("code",[a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("Vi")]),s._v(" nginx.sh\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#!/bin/sh")]),s._v("\nCWD=`pwd`\ncase "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$1")]),s._v(" in\n        start)\n                /nginx/sbin/nginx")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("stop)")]),s._v("\n                kill -2 `ps -ef|grep "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/nginx/sbin/nginx"')]),s._v("|grep -v "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"grep"')]),s._v("|awk "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'{print "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$2")]),s._v("}'")]),s._v(" `")]),s._v("\n                        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("restart)")]),s._v("\n                cd "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$CMD")]),s._v('"')]),s._v("\n                "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$0")]),s._v(" stop\n                "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$0")]),s._v(" start")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v('\n        *)\n        echo $"Usage: $0 '),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("start|stop|restart"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v('"\n        exit 1\nesac\nexit 0\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br")])]),a("h3",{attrs:{id:"二配置tomcat"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#二配置tomcat"}},[s._v("#")]),s._v(" 二配置tomcat")]),s._v(" "),a("h4",{attrs:{id:"_1-下载tomcat5-59"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-下载tomcat5-59"}},[s._v("#")]),s._v(" 1.下载tomcat5.59")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("tar zxvf tomcat5.59\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h3",{attrs:{id:"_2-修改配置文件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-修改配置文件"}},[s._v("#")]),s._v(" 2.修改配置文件")]),s._v(" "),a("p",[s._v("配置数据源")]),s._v(" "),a("p",[s._v("优化tomcat最大并发数")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v('  <Connector port="8080" maxHttpHeaderSize="8192"\n\n           maxThreads="2048" minSpareThreads="100" maxSpareThreads="200"\n\n           enableLookups="false" redirectPort="8443" acceptCount="500"\n\n           connectionTimeout="20000" disableUploadTimeout="true" />\n')])])]),a("p",[s._v("添加虚拟主机")]),s._v(" "),a("p",[s._v("（注:主转发的虚拟主机必须用localhost，否则nginx不能通过内网ip转发，而只有通过域名转发)")]),s._v(" "),a("p",[s._v("测试")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("打开http://ip:8080\n页面能访问则正常\n")])])]),a("p",[s._v("2，  其他的tomcat服务器也用同样的配置")]),s._v(" "),a("h3",{attrs:{id:"三-做tomcat集群"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#三-做tomcat集群"}},[s._v("#")]),s._v(" 三.做tomcat集群")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("两台机器 172.23.254.2  172.23.254.3\n做集群需要修改的文件配置有三个地方\n")])])]),a("p",[s._v("1.修改conf/server.xml配置文件")]),s._v(" "),a("p",[s._v('找到Engine标签，加入属性 jvmRoute="worker1"')]),s._v(" "),a("p",[s._v("找到Cluster标签，去掉注释，同时修改tcpListenAddress为本机ip 172.23.254.2 （注：这一段Cluster必须放在hosts里面）")]),s._v(" "),a("p",[s._v("​")]),s._v(" "),a("p",[s._v("2.修改应用的web.xml")]),s._v(" "),a("p",[s._v("修改web应用里面WEB-INF目录下的web.xml文件，加入标签")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("<distributable/>\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("直接加在"),s._v("之前就可以了")]),s._v(" "),a("p",[s._v("这个是加入tomcat的session复制的，做tomcat集群必须需要这一步，否则用户的session就无法正常使用。")]),s._v(" "),a("p",[s._v("3.开启防火墙")]),s._v(" "),a("p",[s._v("这两个tomcat之间必须开启防火墙信任。")]),s._v(" "),a("p",[s._v("分别启动两个tomcat，查看每一个tomcat是否都启动了8080端口以及4001端口")]),s._v(" "),a("p",[s._v("再用netstat –an 查看链接情况")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("tcp        0      0 172.23.254.2:43320      172.23.254.3:4001      ESTABLISHED\ntcp        0      0 172.23.254.2:46544      172.23.254.3:4001      TIME_WAIT  \ntcp        0      0 172.23.254.2:40118      172.23.254.3:4001      ESTABLISHED\ntcp        0      0 172.23.254.2:4001       172.23.254.3:48804     ESTABLISHED\ntcp        0      0 172.23.254.2:4001       172.23.254.3:34254     ESTABLISHED\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[s._v("如果两台机器的4001端口分别建立了连接，则说明集群配置成功，可以进行session复制。")]),s._v(" "),a("h3",{attrs:{id:"可能存在的问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#可能存在的问题"}},[s._v("#")]),s._v(" 可能存在的问题")]),s._v(" "),a("ol",[a("li",[s._v("session复制问题")])]),s._v(" "),a("p",[s._v("以前用apache做负载均衡的时候，是选择了用 session sticky的模式，这样的话，用户每次进来都会是同一个服务器中的session，不会被转发到其他的服务器上。在这样的情况下，tomcat即使不做session复制也不会影响用户访问。但是nginx并不支持sticky功能。所以必须要做session复制。否则很多地方就根本没法用。比如登录过程，先等到了第一个tomcat上，产生了一个session，在刷新页面，刷到另外一个tomcat的机器上，没有这个session，就会出现问题了。所以程序员在写jsp的时候也要注意这一点")]),s._v(" "),a("p",[s._v("举个简单的例子，比如我们在单机应用情况下修改SESSION中用户的某一个数据，那么通常就是：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("User user = (User)request.getSession().getAttribute(“user”);\nUser.setName(“my name”);\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("​    这样我们就是直接存取出来，然后进行修改，虽然在单机情况下没有问题，但是在集群条件下，这样就导致了多台WEB服务器上的SESSION不同步的问题，因为SESSION并没有改变，Tomcat无法监视session中某个数据的值是否发生了变化。因此，我们还需要执行如下操作以保证SESSION的同步：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("Request.getSession().setAttribute(“user”, user);\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("​    所以，我们在操作SESSION的时候要特别注意！另外的建议就是，我们应该尽可能的不要修改SESSION中的数据。")]),s._v(" "),a("p",[s._v("可能经常会遇到session复制不正常的情况。除了在服务端找原因再也程序上找下原因。都是有可能导致session复制不正常的")]),s._v(" "),a("p",[s._v("2.页面同步")]),s._v(" "),a("p",[s._v("为确保后面tomcat的服务器上的页面程序是一致的，可以采用如下方式")]),s._v(" "),a("p",[s._v("rsync同步，或者做成页面按钮，提供给编辑，修改了程序即使点击同步")]),s._v(" "),a("p",[s._v("共享区域存储，或者采取drbd网络raid模式")]),s._v(" "),a("p",[s._v("3.确认nginx可以转发成功")]),s._v(" "),a("p",[s._v("在nginx上wget一下后面转发的url（包过端口），如果可以打开，那就可以转发过去。如果不能打开，则无法转发")])])}),[],!1,null,null,null);t.default=e.exports}}]);